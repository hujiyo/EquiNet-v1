# EquiNet

## 项目简介

 - EquiNet 旨在从0开始构建一个深度学习模型，通过对319只A股股票420天的历史（2024）数据进行建模，仅仅使用不到半小时的时间，即可训练出一个具备一定预测能力的模型EquiNet
 - EquiNet 基于 PyTorch 的深度学习项目，支持灵活参数配置和高效GPU训练。通过历史数据建模输出未来3天内股票上涨的概率（0-1之间的连续值）。
 - **最新版本采用二分类方案**：专注于预测股票是否会上涨（上涨6%才被标记为上涨），输出0-1之间的概率值，更符合实际交易需求。使用固定的31个测试文件和评估样本，确保评估的一致性和可重复性。
 - **预测性能良好**：在实验条件参数以及实验数据集下，模型总体准确率达到60%，最高可达到71%，测试集AUC最高可达79.5%。在预测为上涨的股票集中，股票上涨真实6%的概率高达55%，远超随机平均水平（35%-38%），体现了一定的预测能力。当然，最佳的效果必须采用最佳的参数配置。
 - **新增测试集损失监控**：训练过程中同时显示训练损失和测试集损失，更好地监控模型训练状态。

## 主要特性

- **Transformer 架构**：强大的时序建模能力，适合金融数据。
- **二分类预测**：专注于预测股票是否会上涨，输出0-1之间的概率值。
- **固定评估集**：使用固定的31个测试文件和评估样本，确保评估的一致性和可重复性。
- **测试集损失监控**：每轮训练后计算并显示测试集损失，帮助判断模型是否过拟合。
- **灵活参数配置**：支持自定义模型维度、层数、训练轮数等，适应不同硬件与需求。
- **归一化处理**：每只股票独立归一化，消除价格量级影响。
- **GPU加速**：自动检测CUDA，充分利用GPU资源。
- **训练过程评估**：每轮训练后自动评估模型当前预测准确率。
- **断点续训**：自动保存最佳模型权重，便于后续加载与继续训练。
- **实用预测**：专注于预测股票上涨概率，更符合实际交易需求。
- **手动尝试调参**：只提供相对基础的config参数，实际可个性化调整参数以追求更高预测效果。

## 目录结构

```
EquiNet/
├── src/
│   ├── predict/		#模型训练好后，将你要预测的股票按照格式做成xlsx放在本文件夹下
│   ├── data/                	# 存放319个.xlsx股票数据文件
│   ├── out/                 	# 训练输出的模型权重
│   ├── train.py         	    # 主训练脚本
│   ├── run.py    	          # 使用模型脚本
│   ├── config.py        	    # 统一配置文件
│   └── ...              	    # 其他可能的源码
├── LICENSE
├── README.md
└── ...
```

## 数据格式说明

- 数据目录：`./data`
- 价格区间：1 ~ 6 元
- 每个`.xlsx`文件对应一只股票，包含420天数据，共319只股票。
- 字段说明（共9列）：
  - `time`：日期（如`2023/06/27`）
  - `start`：开盘价
  - `max`：最高价
  - `min`：最低价
  - `end`：收盘价
  - `volume`：股票成交量
  - `marketvolume`：市场总成交量 最新被移除
  - `marketlimit`：大盘涨跌幅（如-1%） 最新被移除
  - `marketrange`：大盘指数波动宽度 最新被移除
- 数据来源：通达信

## 模型输出说明

### 二分类预测
- **输出格式**：0-1之间的连续概率值
- **预测逻辑**：预测未来3天内股票是否会上涨（涨幅≥6%）
- **决策机制**：
  - 概率 > 0.5 → 预测上涨，建议买入
  - 概率 < 0.5 → 预测不上涨，建议不买
- **风险控制**：
  - 保守策略：概率 > 0.8 才买入
  - 平衡策略：概率 > 0.7 买入
  - 激进策略：概率 > 0.5 买入

### 示例输出
```
股票A: 0.85 → 85%概率上涨 → 买入
股票B: 0.35 → 35%概率上涨 → 不买
股票C: 0.62 → 62%概率上涨 → 买入
```

## 安装与环境

- Python 3.8+
- PyTorch
- pandas、numpy
- tqdm

安装依赖：
```bash
pip install torch pandas numpy tqdm
```

## 使用流程

### 快速开始
1. **克隆项目**
   ```bash
   git clone https://gitee.com/hujiyo/EquiNet.git
   ```

2. **下载数据集**

   数据集链接：https://huggingface.co/datasets/Mhuixs/EquiNet-v1-319_420
   下载后将数据集放在`./data`目录下。每个`.xlsx`文件对应一只股票，包含420天数据，共319只股票。

3. **运行训练脚本**
   ```bash
   python src/train.py
   ```

4. **模型评估**
   - 训练完成后，模型权重保存在`./out/EnhancedEquiNet_{d_model}.pth`。
   - 可使用`src/run.py`对模型进行评估：
     ```bash
     python src/run.py
     ```

### 训练结果示例（最新版本可能略微不同 &&参数需要自己去调）
```
Epoch 59/60, LR: 0.000001 (正常训练)
  本轮数据分布: 正样本=14758(36.0%), 负样本=26202(64.0%)
  动态权重: 正样本权重=1.388, 负样本权重=0.782
  余弦退火进度: 96.4%, 理论学习率: 4.26e-06
  训练进度: 100.0% (20/20), 平均损失: 0.4358

  随机样本预测详情 (第59轮):
  样本   真实标签     模型输出         预测概率       预测标签     预测结果
  ---- -------- ------------ ---------- -------- --------
  1    不上涨      1.6282       0.8359     上涨       ✗误涨
  2    上涨       0.2500       0.5622     上涨       ✓正确
  3    不上涨      -1.9588      0.1236     不上涨      ✓正确
  4    上涨       -4.6889      0.0091     不上涨      ✗漏涨
  5    不上涨      1.5166       0.8200     上涨       ✗误涨
  6    上涨       1.2529       0.7778     上涨       ✓正确
  7    不上涨      3.1641       0.9595     上涨       ✗误涨
  8    上涨       0.5049       0.6236     上涨       ✓正确
  9    不上涨      0.1886       0.5470     上涨       ✗误涨
  10   上涨       -0.4990      0.3778     不上涨      ✗漏涨

  不上涨: 443/646 = 0.686
  上涨: 260/354 = 0.734
  上涨准确率: 260/463 = 0.562 准确率: 310/463 = 0.670
  总体准确率: 0.703
  评估得分: -17.0 / 1000 = -0.017
  AUC得分: 0.7948
  测试集损失: 0.5637
```

### 常规训练流程
1. **准备数据**
   - 将319个`.xlsx`股票数据文件放入`./data`目录下。
   数据集链接：https://huggingface.co/datasets/Mhuixs/EquiNet-v1-319_420

2. **运行训练脚本**
   ```bash
   python src/train.py
   ```
   - 程序会自动使用配置文件中的参数进行训练。
   - 训练过程中显示进度、损失、学习率及每轮评估准确率。

3. **模型评估**
   - 训练完成后，模型权重保存在`./out/EnhancedEquiNet_{d_model}.pth`。
   - 可使用`src/run.py`对模型进行评估：
     ```bash
     python src/run.py
     ```

## 配置文件使用说明

<details>
<summary><strong>📋 点击展开：配置文件详细使用说明</strong></summary>

### 概述

`config.py` 是 EquiNet 项目的统一配置文件，用于管理模型参数、训练参数和评估参数。通过这个配置文件，您可以轻松地调整模型的各种设置，而无需修改多个文件。

### 配置文件结构

配置文件包含以下几个主要部分：

#### 1. 模型架构参数 (ModelConfig)
- **基础模型参数**: 输入维度、模型维度、注意力头数、层数等
- **注意力机制参数**: Dropout比率

#### 2. 训练参数 (TrainingConfig)
- **基础训练参数**: 训练轮数、学习率、批处理大小
- **优化器参数**: 权重衰减、梯度裁剪
- **学习率调度器参数**: 步长、衰减因子
- **动态权重调整参数**: 窗口大小、权重范围

#### 3. 数据参数 (DataConfig)
- **数据路径**: 数据目录、输出目录
- **数据分割参数**: 测试集比例、随机种子
- **样本生成参数**: 历史数据长度（60天）、预测天数（3天）
- **二分类阈值**: 上涨阈值（6%）
- **评估参数**: 评估样本数量（1000个）

#### 4. 评估参数 (EvaluationConfig)
- **评分规则**: 预测正确+1分、假阳性惩罚-1分、假阴性惩罚-0.5分
- **评估设置**: 评估样本数、批处理大小

#### 5. 设备配置 (DeviceConfig)
- **设备管理**: 自动检测GPU/CPU
- **设备信息**: 打印设备信息

#### 6. 模型保存配置 (ModelSaveConfig)
- **模型文件名**: 最佳模型、最终模型文件名
- **路径管理**: 获取模型保存路径

### 使用方法

#### 1. 查看当前配置
```bash
python src/config.py
```

#### 2. 修改配置参数
直接编辑 `src/config.py` 文件中的相应参数值。例如：

```python
# 修改训练参数
TrainingConfig.EPOCHS = 100                    # 增加训练轮数
TrainingConfig.LEARNING_RATE = 0.0005          # 降低学习率

# 修改模型参数
ModelConfig.D_MODEL = 256                       # 增加模型维度
ModelConfig.NHEAD = 16                          # 增加注意力头数

# 修改数据参数
DataConfig.CONTEXT_LENGTH = 90                  # 增加历史数据长度
DataConfig.UPRISE_THRESHOLD = 0.05              # 调整大涨阈值
```
以上参数仅供参考，需要自己去调参，找到最佳的参数配置。

#### 3. 查看配置摘要
```bash
python src/config.py
```
系统会打印当前配置摘要。

#### 4. 运行训练
```bash
python src/train.py
```
训练脚本会自动使用配置文件中的参数。

#### 5. 测试模型
```bash
python src/run.py
```
测试脚本也会使用配置文件中的参数。
使用模型对./src/predict/下的股票数据进行预测，
预测结果会保存在./src/predict/result.xlsx文件中。

### 注意事项

1. **参数一致性**: 确保训练和测试时使用相同的配置参数
2. **内存限制**: 增加模型维度时注意GPU内存限制
3. **训练时间**: 增加训练轮数或模型复杂度会显著增加训练时间
4. **数据质量**: 调整类别阈值可能影响数据质量和模型性能

</details>

## 项目修改LOG

- 2025.10.18:数据集统一放到huggingface上供大家下载。修复索引越界错误，修复动态权重计算错误。改积分评分制为实际涨跌评分制。
- 2025.10.15:增加学习率预热和余弦退火调度机制，残差连接改为Pre-Norm架构，调整了部分参数。进一步提升了模型训练时的稳定性。
- 2025.9.16:**重要修复** - 修正了原来错误的权重平衡方法,模型的预测能力各项指标普遍上涨5%-15%。取消专业头机制，优化训练时数据采样流程，改为每批次提前批量抽取数据，训练效率提升50%以上。
- 2025.8.1: **重大更新** - 重构采用二分类方案，专注于预测股票是否会上涨，输出0-1之间的概率值，更符合实际交易需求。使用固定的31个测试文件和评估样本，确保评估的一致性和可重复性。模型准确率达到58%，接近60%目标。在预测为上涨的股票集中，股票上涨2%的概率高达49%，远超随机平均水平（34%-42%）
- 2025.6.1: **架构优化** - 重新设计模型架构，增加模型维度(128)和层数(3)，优化注意力头分配(价格3头、成交量2头、波动率2头、模式1头)，使用时间感知注意力机制，提升模型表达能力。
- 2025.5.31:积分制成为默认机制，增加时间感知位置编码、Focal Loss损失函数、结合标准正弦余弦位置编码、指数衰减机制、种类差异化多头注意力机制、多尺度注意力，加入了残差连接和层归一化。
- 2025.5.12:增加mark积分制判别最优模型,但保留原判别机制
- 2025.5.1:项目start ~

## 参与贡献的两种路径

1. Fork 本仓库 --> 建立 Pull Request
2. 联系hujiyo并加入项目维护者 --> 新建分支（`dev_yourname`）-->维护项目

## 联系方式

- 邮箱: hj18914255909@outlook.com || Mhuixs.db@outlook.com hujiyo
- WeChat: wx17601516389

## 进入炼丹交流群

- 加V：wx17601516389后回复“炼丹交流群”即可

## 致谢

1. 感谢通达信提供的股票数据（虽然我是买了初级会员才获得的数据的~QvQ~）。
2. 项目当前以及未来的所有代码均会是在QwQ-32b、豆包、deepseek、ChatGPT等等大佬的帮助下完成的，在此表示感谢。
最最最初对QwQ的prompt：
```
背景介绍：现在你在进行一个利用python进行模型训练的2030年编程比赛，参赛者有中国昔日之光：deepseek-r1:671b满血版、openAI最新编程大神：ChatGPT6.0:9600b世界版、千问推理模型QwQ-32b（你）......注意，你可以无限长时间循环分步骤思考，但是你的机会只有一次！
现在是试卷的最后一题：在./下写一个.py模型训练程序，模型数据存放在./data下，那里有着319个.xlsx文件，每个文件对应一只股票，每个文件的有效行数为421行，其中第一行也就是表头字段分别有time	start	max	min	end	volume	marketvolume	marketlimit	marketrange这9个字段，2-421行都是数据，也就是说每个文件实际上都是包含一只股票420天的基本情况和当天大盘的情况。每个文件的time都是420天并且初始日期都是对照相同的，start/end	是开/收盘价，max/min是最高/低价，volume是股票量能，marketvolume是市场量能，marketlimit是大盘涨跌幅，marketrange是大盘指数的波动宽度，（比如marketlimit为-1%，marketrange为50，则暗示大盘下跌30个点，宽度在50个点，波动很大）	模型的输出结果是对未来3天的情况进行概率预测，分别是上涨3%的概率，下跌2%的概率，保持-2%~3%的概率，例如输出：涨5%：\n跌3%：54%，\n稳：25%。
提示：
1.建议使用transformer架构，程序开始需要提示用户输入想要的模型训练的大小参数和训练轮次。为避免用户不懂，你还要有提示信息（比如对最终模型效果的影响、对模型最终参数量的影响等等）
2.训练过程中，使用随机上下文长度（20天-100天），这种随机效果可以变相降低数据量有限的弊端，然后对下面3天进行预测
3.训练过程中要给出进度信息（包括学习率），每轮训练结束后要增加一个效果环节，具体如下：用相同的方法从数据中随机获得片段作为输入然后，将概率大的视为模型的选择，循环多次即可计算出当前模型预测成功的概率并打印。
4.不同股票的价格不同，模型的目标是掌握其中更深层次的规律，所以训练数据要进行统一的归一化
5.使用支持CUDA的gpu进行训练
6.time字段的格式为'2023/06/27'
7.不要提前确定好所有的数据然后轮流开始训练，这违背了我随机思想的初衷，我要的是训练输入上的完全随机，每轮1000组随机输入
```

## 最新公告

数据集不再上传到github,而是统一放到huggingface上方便大家下载

该版本为EquiNet的第一个正式大版本（v1.x.x）

之后EquiNet的第二个大版本可能不会完全开源，但是第一个版本依旧会进行正常的维护、更新
